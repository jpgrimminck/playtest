<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Play</title>

  <!-- Configuración para instalar como app en iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Play">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Escala responsive -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Íconos de la app -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <!-- Estilos -->
  <link rel="stylesheet" href="styles.css">

  <meta name="theme-color" content="#222222">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-touch-fullscreen" content="yes">
  <link rel="manifest" href="manifest.json">

  <style>
    :root {
      --sat: env(safe-area-inset-top);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
      --sar: env(safe-area-inset-right);
    }
    html {
      height: -webkit-fill-available;
    }
    body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      margin: 0;
      overflow: hidden;
      height: 100vh;
      height: -webkit-fill-available;
    }
    .container {
      display: flex;
      height: 100%;
      max-height: 100vh;
      max-height: -webkit-fill-available;
      padding-top: env(safe-area-inset-top);
    }
    .miniatura {
      width: 100px;
      height: 100px;
      background-size: cover;
      background-position: center;
      border: none;
      border-radius: 0px;
      margin: 0px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .miniatura:hover {
      transform: scale(1);
    }
    #miniaturasContainer {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 0px;
      gap: 0px;
    }
    /* Estilos para el slider (input range) */
    #seekBar {
      -webkit-appearance: none;
      width: 80%; /* Ancho reducido al 80% */
      height: 6px;
      background: #ccc;
      outline: none;
      border-radius: 3px;
      margin: 10px auto; /* Centrado horizontal */
      display: block; /* Asegura que el margin auto funcione */
      pointer-events: none;
    }

    /* Thumb del slider (para Webkit: Chrome, Safari, Edge) */
    #seekBar::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;  /* Mantenemos el tamaño original */
      height: 24px;
      background: #4a9eff;
      border: 2px solid white;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 0 10px transparent;  /* Área transparente alrededor */
      margin-top: 0px;  /* Ajuste perfecto para el centro */
      transition: transform 0.1s ease;
      position: relative;
      z-index: 1;
    }

    /* Aumentamos el área de interacción con pseudo-elementos */
    #seekBar::-webkit-slider-thumb::before {
      content: '';
      position: absolute;
      width: 44px;  /* 24px + 20px extra */
      height: 44px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: transparent;
      border-radius: 50%;
      pointer-events: all;
    }

    /* Thumb para Firefox */
    #seekBar::-moz-range-thumb {
      width: 24px;
      height: 24px;
      background: #4a9eff;
      border: 2px solid white;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
    }

    /* Thumb para IE/Edge */
    #seekBar::-ms-thumb {
      width: 24px;
      height: 24px;
      background: #4a9eff;
      border: 2px solid white;
      border-radius: 50%;
      cursor: pointer;
    }

    /* Mantenemos todos los eventos de interacción originales */
    #seekBar::-webkit-slider-thumb {
      pointer-events: all;
    }

    /* Efecto al interactuar con el thumb */
    #seekBar::-webkit-slider-thumb:hover,
    #seekBar::-moz-range-thumb:hover,
    #seekBar::-ms-thumb:hover {
      transform: scale(1.1);
    }

    .sidebar {
      padding-top: 0px; /* Valor fijo en lugar de env(safe-area-inset-top) */
    }
  </style>
</head>

<body>
  <!-- ===========================  ESTRUCTURA HTML  =========================== -->
  <div class="container">
    <!-- Barra lateral -->
    <div class="sidebar">
      <div id="miniaturasContainer"></div>
    </div>

    <!-- Sección principal -->
    <div class="main">
      <button id="guitarraBtn"><span style="font-size:28px;">🎸</span></button>
      <div class="caratula" id="cover"></div>
      <div class="info">
        <div class="nombreCancion" id="nombreCancion"></div>
        <div class="artista"        id="artista"></div>
      </div>
      <input type="range" id="seekBar" value="0" min="0" step="1">
      <button id="playPause"><div id="icon" class="icon play-icon"></div></button>
    </div>
  </div>

  <!-- Botón de detalles -->
  <a id="detailsArrow" class="details-arrow" title="Ver detalles">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 4l8 8-8 8" stroke="#4a9eff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </a>

  <!-- Etiqueta de versión -->
  <div class="version" id="version-btn" style="cursor: pointer; user-select: none;">
    Versión 4.9
  </div>
  <div id="spinner"></div>

  <!-- ===========================  AUDIOS OCULTOS  =========================== -->
  <audio id="audio"></audio>
  <audio id="audioAlt" style="display:none;"></audio>

  <!-- ==============================  SCRIPTS  =============================== -->
  <script>
    // Control del spinner al hacer clic en la versión
    document.getElementById('version-btn').addEventListener('click', function() {
      const spinner = document.getElementById('spinner');
      spinner.style.display = 'block';

      setTimeout(() => {
        window.location.reload(true);
      }, 1000);
    });

    /* --------------------------------------------------------------------------
       VARIABLES Y CONSTANTES GLOBALES
    -------------------------------------------------------------------------- */
    const totalCovers = 72;               // Total de carátulas
    const coversConGuitarra = [9, 10, 62];    // Índices que poseen audio sin guitarra

    // Variables de carpetas
    const folders = {
      1: 'songs',   // Audios
      2: 'covers'   // Miniaturas
    };

    // Metadatos de canciones (nombre y artista)
    const metadatos = {
        1:  {nombre:'Día de Enero',                         artista:'Shakira'},
        2:  {nombre:'Hey Jude',                             artista:'Beatles'},
        3:  {nombre:'The Scientist',                        artista:'Coldplay'},
        4:  {nombre:'Shake it Off',                         artista:'Taylor Swift'},
        5:  {nombre:'Main Theme',                           artista:'Gravity Falls'},
        6:  {nombre:'Riptide',                              artista:'Vance Joy'},
        7:  {nombre:'El Camión de Samu',                    artista:'Hermanos'},
        8:  {nombre:'Capaz',                                artista:'Alleh & Yorghaki'},
        9:  {nombre:'Drive',                                artista:'Incubus'},
        10: {nombre:"Back to december (Taylor's Version)",  artista:'Taylor Swift'},
        11: {nombre:'Gravity Falls',                        artista:'Pedro y Clemente'},
        12: {nombre:'Burrito Sabanero',                     artista:'Borja y Max'},
        13: {nombre:"I'm still standing",                   artista:'Clemente'},
        14: {nombre:'Diente blanco, No te vayas!',          artista:'Clemente y Celeste'},
        15: {nombre:"Don't Stop Believin'",                 artista:'Journey'},
        16: {nombre:"All of me",                            artista:'John Legend'},
        17: {nombre:"Somewhere Only we Know",               artista:'Keane'},
        18: {nombre:"Someone like You",                     artista:'Adele'},
        19: {nombre:"Podré ir a Europa",                    artista:'Martín y Emma'},
        20: {nombre:"Muerte en Hawaii",                     artista:'Calle 13'},
        21: {nombre:"Popó, Así me llamo yo",                artista:"Martín y Emma"},
        22: {nombre:"Osito Gominola",                       artista:"Samuel"},
        23: {nombre:"Ritmo Sideral",                        artista:"Clemente"},
        24: {nombre:"Pepita",                               artista:"Samuel"},
        25: {nombre:"De Bebé a Niño",                       artista:"Emma"},
        26: {nombre:"Steve's Lava Chicken",                 artista:"Minecraft"},
        27: {nombre:"In the Stars",                         artista:"Benson Boone"},
        28: {nombre:"Something just like This",             artista:"The Chainsmokers & Coldplay"},
        29: {nombre:"Zorba",                                artista:"El Griego"},      
        30: {nombre:"Chiu Chiu",                       artista:"Borja"},
        31: {nombre:"Cuando sea mayor",                artista:"Josefa"},
        32: {nombre:"Danke Danke",                     artista:"Emma"},
        33: {nombre:"Do re mi fa sol",                 artista:"Bernardo"},
        34: {nombre:"El colegio es para aprender",     artista:"Emma"},
        35: {nombre:"Enchanted",                       artista:"Clarita"},
        36: {nombre:"Estrellita",                      artista:"Rafael"},
        37: {nombre:"Gallo Pelado",                    artista:"Borja"},
        38: {nombre:"Gohstbuster",                     artista:"Clemente"},
        39: {nombre:"Jurassic Park",                   artista:"Clemente"},
        40: {nombre:"La jardinera",                    artista:"Lucas"},
        41: {nombre:"La Maldita Roberta",              artista:"Martín"},
        42: {nombre:"Long Live",                       artista:"Clarita"},
        43: {nombre:"Milo el doctor",                  artista:"Pedro"},
        44: {nombre:"Piratas del caribe",              artista:"Raimundo"},
        45: {nombre:"Polka de los perros",             artista:"Clemente"},
        46: {nombre:"Schwarz und weiss",               artista:"Martín"},
        47: {nombre:"Sky full of stars",               artista:"Josefa"},
        48: {nombre:"Solsito porfavor",                artista:"Emma"},
        49: {nombre:"Star Wars",                       artista:"Lucas"},
        50: {nombre:"Thunderstruck",                   artista:"Lucas"},
        51: {nombre:"Yo nunca vi televisión",          artista:"Martín"},
        52: {nombre:"Yo vendo unos ojos negros",       artista:"Eduardo"},
        53: {nombre:"Jurassic Park",                   artista:"Agustín"},
        54: {nombre:"Los monitos",                     artista:"Josefa y Emilio"},
        55: {nombre:"Perdonarte para que",             artista:"Clarita"},
        56: {nombre:"Rodolfo el Reno",                 artista:"Josefa"},
        57: {nombre:"With you",                        artista:"Clarita"},
        58: {nombre:"El mas pequeño",                  artista:"Samuel"},
        59: {nombre:"I Don't Care",                    artista:"Max"},
        60: {nombre:"Bundle of Joy",                   artista:"Florencia"},
        61: {nombre:"Himno a la Alegría",              artista:"Grupo Musical"},
        62: {nombre:"Message in a Battle",             artista:"The Police"},
        63: {nombre:"Faded",                           artista:"Alan Walker"},
        64: {nombre:"Theme Song",                      artista:"Piratas del Caribe"},
        65: {nombre:"Maguito Explosivo",               artista:"31 Minutos"},
        66: {nombre:"Panamericana",                    artista:"Max Segers"},
        67: {nombre:"Rin del Angelito",                artista:"Violeta Parra"},
        68: {nombre:"Main Theme",                      artista:"Mario Bross"},
        69: {nombre:"Hey Jude",                        artista:"Patricia y Pedro"},
        70: {nombre:"El Cigarrito",                    artista:"Juanita y Juan Pablo"},
        71: {nombre:"Jasmine Flower",                  artista:"Folklore Chino"},
        72: {nombre:"Llueve sobre la ciudad",          artista:"Los Bunkers"},
        
        
    };

    /* --------------------------------------------------------------------------
       ELEMENTOS DEL DOM
    -------------------------------------------------------------------------- */
    const miniaturasContainer = document.getElementById('miniaturasContainer');
    const nombreCancionEl     = document.getElementById('nombreCancion');
    const artistaEl           = document.getElementById('artista');
    const audio               = document.getElementById('audio');
    const audioAlt            = document.getElementById('audioAlt');
    const guitarraBtn         = document.getElementById('guitarraBtn');
    const playPauseBtn        = document.getElementById('playPause');
    const icon                = document.getElementById('icon');
    const cover               = document.getElementById('cover');
    const seekBar             = document.getElementById('seekBar');

    /* Estado de audio actual */
    let currentAudio = audio;
    let isAlt        = false;             // ¿Estamos usando audio alternativo?

    /* --------------------------------------------------------------------------
       FUNCIONES PRINCIPALES
    -------------------------------------------------------------------------- */
    function selectAudio (filename, coverImage, metadata) {
      if (currentAudio && !currentAudio.paused) currentAudio.pause();

      audio.src = `${folders[1]}/${filename}`;
      cover.style.backgroundImage = `url('${folders[2]}/${coverImage}')`;

      nombreCancionEl.textContent = metadata.nombre;
      artistaEl.textContent       = metadata.artista;

      localStorage.setItem('selectedAudio',   `${folders[1]}/${filename}`);
      localStorage.setItem('selectedCover',   `${folders[2]}/${coverImage}`);
      localStorage.setItem('selectedNombre',  metadata.nombre);
      localStorage.setItem('selectedArtista', metadata.artista);

      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title:  metadata.nombre,
          artist: metadata.artista,
          artwork:[{ src: `${folders[2]}/${coverImage}`, sizes:'512x512', type:'image/jpeg' }]
        });
        navigator.mediaSession.setActionHandler('play',  () => { currentAudio.play();  setIcon('pause'); });
        navigator.mediaSession.setActionHandler('pause', () => { currentAudio.pause(); setIcon('play');  });
      }

      const coverIndex = parseInt(filename.match(/(\d+)\.mp3/)[1], 10);
      if (coversConGuitarra.includes(coverIndex)) {
        guitarraBtn.style.display = 'flex';
        guitarraBtn.disabled      = true;
        guitarraBtn.style.filter  = 'grayscale(100%)';
        guitarraBtn.style.opacity = '0.6';
        guitarraBtn.classList.remove('active');

        audioAlt.src = `${folders[1]}/` + filename.replace('.mp3','_sg.mp3');
        audioAlt.preload = 'auto';
        audioAlt.load();
        audioAlt.addEventListener('canplaythrough', () => {
          guitarraBtn.disabled     = false;
          guitarraBtn.style.filter = 'none';
          guitarraBtn.style.opacity= '1';
        }, {once:true});
      } else {
        guitarraBtn.style.display = 'none';
      }

      currentAudio = audio;
      currentAudio.load();
      seekBar.value = 0;
      seekBar.max   = 1;
      setIcon('play');
    }

    function togglePlay() {
      if (!currentAudio.src) return;

      // Sincronizar el tiempo del slider con el audio antes de reproducir
      currentAudio.currentTime = parseFloat(seekBar.value);

      if (currentAudio.paused) {
        const playPromise = currentAudio.play();
        if (playPromise !== undefined) {
          playPromise.catch(error => {
            console.error("Error playing audio:", error);
          });
        }
      } else {
        currentAudio.pause();
        setIcon('play');
      }
    }

    function setIcon (state) {
      if (state === 'play') {
        icon.className = 'icon play-icon';
        icon.innerHTML = '';
      } else {
        icon.className = 'pause-icon';
        icon.innerHTML = '<div></div><div></div>';
      }
    }

    [audio, audioAlt].forEach(aud => {
      aud.addEventListener('timeupdate', e => {
        if (!isNaN(e.target.duration)) {
          seekBar.max   = Math.floor(e.target.duration);
          seekBar.value = Math.floor(e.target.currentTime);
        }
      });
      aud.addEventListener('ended', () => setIcon('play'));
      aud.addEventListener('playing', () => setIcon('pause'));
    });

    seekBar.addEventListener('input', () => {
      currentAudio.currentTime = seekBar.value;
    });

    playPauseBtn.addEventListener('click', togglePlay);

    guitarraBtn.addEventListener('click', () => {
      const savedAudio = localStorage.getItem('selectedAudio');
      const coverIndex = parseInt(savedAudio.match(/(\d+)\.mp3/)[1], 10);
      if (!coversConGuitarra.includes(coverIndex)) return;

      const time    = currentAudio.currentTime;
      const playing = !currentAudio.paused;

      guitarraBtn.classList.toggle('active');
      isAlt = guitarraBtn.classList.contains('active');
      localStorage.setItem('isAlt', isAlt.toString());

      currentAudio.pause();
      currentAudio = isAlt ? audioAlt : audio;
      currentAudio.currentTime = time;
      if (playing) currentAudio.play();
    });

    window.addEventListener('DOMContentLoaded', () => {
      const savedAudio   = localStorage.getItem('selectedAudio')   || `${folders[1]}/1.mp3`;
      const savedCover   = localStorage.getItem('selectedCover')   || `${folders[2]}/cover1.jpeg`;
      const savedNombre  = localStorage.getItem('selectedNombre')  || metadatos[1].nombre;
      const savedArtista = localStorage.getItem('selectedArtista') || metadatos[1].artista;
      const savedIsAlt   = localStorage.getItem('isAlt') === 'true';

      cover.style.backgroundImage = `url('${savedCover}')`;
      nombreCancionEl.textContent = savedNombre;
      artistaEl.textContent       = savedArtista;
      audio.src = savedAudio;

      const coverIndex = parseInt(savedAudio.match(/(\d+)\.mp3/)[1], 10);
      guitarraBtn.style.display = coversConGuitarra.includes(coverIndex) ? 'flex' : 'none';

      if (coversConGuitarra.includes(coverIndex) && savedIsAlt) {
        isAlt        = true;
        guitarraBtn.classList.add('active');
        currentAudio = audioAlt;
      } else {
        isAlt        = false;
        currentAudio = audio;
      }

      if (coversConGuitarra.includes(coverIndex)) {
        audioAlt.src = savedAudio.replace('.mp3', '_sg.mp3'); // Solo si tiene versión sin guitarra
        audioAlt.preload = 'auto';
        audioAlt.load();
      }

      audio.addEventListener('loadedmetadata', () => {
        seekBar.max = currentAudio.duration;
        seekBar.value = 0;
        setIcon('play');
      });

      audio.addEventListener('timeupdate', () => {
        if (!isNaN(currentAudio.duration)) {
          seekBar.value = currentAudio.currentTime;
        }
      });

      /* Generar botones de miniaturas en orden inverso */
      for (let i = totalCovers; i >= 1; i--) {
        const btn = document.createElement('button');
        btn.className = 'miniatura';
        btn.setAttribute('data-label', i);
        btn.style.backgroundImage = `url('${folders[2]}/cover${i}.jpeg')`;
        btn.onclick = () => selectAudio(`${i}.mp3`, `cover${i}.jpeg`, metadatos[i]);
        miniaturasContainer.appendChild(btn);
      }

      // Mostrar el botón de detalles
      const detailsArrow = document.getElementById('detailsArrow');
      detailsArrow.classList.add('show');

      // Manejar clic en el botón de detalles
      detailsArrow.addEventListener('click', () => {
        // Obtener el ID de la canción actual del src del audio
        const currentSongId = currentAudio.src.split('/').pop().replace('.mp3', '').replace('_sg', '');
        const currentTime = currentAudio.currentTime;
        
        // Construir la URL de la carátula basada en el ID de la canción
        const currentCover = `${folders[2]}/cover${currentSongId}.jpeg`;
        
        // Construir la URL con los parámetros necesarios
        const params = new URLSearchParams({
          song: currentSongId,
          cover: currentCover,
          title: nombreCancionEl.textContent,
          audio: `${folders[1]}/${currentSongId}.mp3`,
          time: currentTime
        });
        
        window.location.href = `details.html?${params.toString()}`;
      });

      // Añadir event listener para cambios de orientación
      window.addEventListener('resize', function() {
        adjustThumbnailsLayout();
      });

      function adjustThumbnailsLayout() {
        const isPortrait = window.innerHeight > window.innerWidth;
        const miniaturasContainer = document.getElementById('miniaturasContainer');
        
        if (isPortrait) {
          // Configuración para orientación vertical (9 miniaturas)
          miniaturasContainer.style.justifyContent = 'center';
          miniaturasContainer.style.gap = '0px';
        } else {
          // Configuración para orientación horizontal (7 miniaturas)
          miniaturasContainer.style.justifyContent = 'flex-start';
          miniaturasContainer.style.gap = '0px';
        }
      }

      // Llamar a la función al cargar la página para configurar el diseño inicial
      adjustThumbnailsLayout();

      // Verificar si hay un tiempo de reproducción guardado (proveniente de details.html)
      const urlParams = new URLSearchParams(window.location.search);
      const savedTimeFromURL = urlParams.get('time');
      const savedTimeFromStorage = localStorage.getItem('audioCurrentTime');
      const timeToSet = savedTimeFromURL || savedTimeFromStorage;

      if (timeToSet) {
        const parsedTime = parseFloat(timeToSet);
        let attempts = 0;
        const maxAttempts = 10; // Aumentamos el número de intentos

        const setAudioTime = () => {
          if (currentAudio.readyState >= HTMLMediaElement.HAVE_METADATA) {
            currentAudio.currentTime = parsedTime;
            console.log(`Tiempo establecido: ${parsedTime} segundos.`);
          } else {
            attempts++;
            if (attempts < maxAttempts) {
              console.log(`Intento ${attempts}: Audio no listo, reintentando...`);
              setTimeout(setAudioTime, 300); // Reintentar después de 300ms
            } else {
              console.error("No se pudo establecer el tiempo después de varios intentos.");
            }
          }
        };

        // Escuchar eventos clave del audio
        const handleLoadedMetadata = () => {
          currentAudio.currentTime = parsedTime;
          currentAudio.removeEventListener('loadedmetadata', handleLoadedMetadata);
        };
        const handleCanPlay = () => {
          currentAudio.currentTime = parsedTime;
          currentAudio.removeEventListener('canplay', handleCanPlay);
        };

        currentAudio.addEventListener('loadedmetadata', handleLoadedMetadata);
        currentAudio.addEventListener('canplay', handleCanPlay);
        currentAudio.load(); // Forzar la recarga

        // Intentar establecer el tiempo inmediatamente
        setAudioTime();
      }

      // Guardar el tiempo actual en localStorage al salir de la página
      window.addEventListener('beforeunload', () => {
        localStorage.setItem('audioCurrentTime', currentAudio.currentTime.toString());
      });
    });
  </script>
</body>
</html>
