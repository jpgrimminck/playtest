<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Play</title>

  <!-- Configuración para instalar como app en iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Play">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Escala responsive -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Íconos de la app -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <!-- Estilos -->
  <link rel="stylesheet" href="styles.css">

  <meta name="theme-color" content="#222222">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-touch-fullscreen" content="yes">
  <link rel="manifest" href="manifest.json">
  
</head>

<body>
  <!-- ===========================  ESTRUCTURA HTML  =========================== -->
  <div class="container">
    <!-- Barra lateral -->
    <div class="sidebar">
      <div id="miniaturasContainer"></div>
    </div>

    <!-- Sección principal -->
    <div class="main">
      <button id="guitarraBtn"><span style="font-size:28px;">🎸</span></button>
      <div class="caratula" id="cover"></div>
      <div class="info">
        <div class="nombreCancion" id="nombreCancion"></div>
        <div class="artista"        id="artista"></div>
      </div>
      <input type="range" id="seekBar" value="0" min="0" step="1">
      <button id="playPause"><div id="icon" class="icon play-icon"></div></button>
    </div>
  </div>

  <!-- Botón de detalles -->
  <a id="detailsArrow" class="details-arrow" title="Ver detalles">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 4l8 8-8 8" stroke="#4a9eff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </a>

  <!-- Etiqueta de versión -->
  <div class="version" id="version-btn" style="cursor: pointer; user-select: none;">
    Versión 4.9
  </div>
  <div id="spinner"></div>

  <!-- ===========================  AUDIOS OCULTOS  =========================== -->
  <audio id="audio"></audio>
  <audio id="audioAlt" style="display:none;"></audio>

  <!-- ==============================  SCRIPTS  =============================== -->
  <script>
    // Control del spinner al hacer clic en la versión
    document.getElementById('version-btn').addEventListener('click', function() {
      const spinner = document.getElementById('spinner');
      spinner.style.display = 'block';

      setTimeout(() => {
        window.location.reload(true);
      }, 1000);
    });

    /* --------------------------------------------------------------------------
       VARIABLES Y CONSTANTES GLOBALES
    -------------------------------------------------------------------------- */
    const totalCovers = 62;               // Total de carátulas
    const coversConGuitarra = [9, 10];    // Índices que poseen audio sin guitarra

    // Variables de carpetas
    const folders = {
      1: 'songs',   // Audios
      2: 'covers'   // Miniaturas
    };

    // Metadatos de canciones (nombre y artista)
    const metadatos = {
        1:  {nombre:'Día de Enero',                         artista:'Shakira'},
        2:  {nombre:'Hey Jude',                             artista:'Beatles'},
        3:  {nombre:'The Scientist',                        artista:'Coldplay'},
        4:  {nombre:'Shake it Off',                         artista:'Taylor Swift'},
        5:  {nombre:'Main Theme',                           artista:'Gravity Falls'},
        6:  {nombre:'Riptide',                              artista:'Vance Joy'},
        7:  {nombre:'El Camión de Samu',                    artista:'Hermanos'},
        8:  {nombre:'Capaz',                                artista:'Alleh & Yorghaki'},
        9:  {nombre:'Drive',                                artista:'Incubus'},
        10: {nombre:"Back to december (Taylor's Version)",  artista:'Taylor Swift'},
        11: {nombre:'Gravity Falls',                        artista:'Pedro y Clemente'},
        12: {nombre:'Burrito Sabanero',                     artista:'Borja y Max'},
        13: {nombre:"I'm still standing",                   artista:'Clemente'},
        14: {nombre:'Diente blanco, No te vayas!',          artista:'Clemente y Celeste'},
        15: {nombre:"Don't Stop Believin'",                 artista:'Journey'},
        16: {nombre:"All of me",                            artista:'John Legend'},
        17: {nombre:"Somewhere Only we Know",               artista:'Keane'},
        18: {nombre:"Someone like You",                     artista:'Adele'},
        19: {nombre:"Podré ir a Europa",                    artista:'Martín y Emma'},
        20: {nombre:"Muerte en Hawaii",                     artista:'Calle 13'},
        21: {nombre:"Popó, Así me llamo yo",                artista:"Martín y Emma"},
        22: {nombre:"Osito Gominola",                       artista:"Samuel"},
        23: {nombre:"Ritmo Sideral",                        artista:"Clemente"},
        24: {nombre:"Pepita",                               artista:"Samuel"},
        25: {nombre:"De Bebé a Niño",                       artista:"Emma"},
        26: {nombre:"Steve's Lava Chicken",                 artista:"Minecraft"},
        27: {nombre:"In the Stars",                         artista:"Benson Boone"},
        28: {nombre:"Something just like This",             artista:"The Chainsmokers & Coldplay"},
        29: {nombre:"Zorba",                                artista:"El Griego"},      
        30: {nombre:"Chiu Chiu",                       artista:"Borja"},
        31: {nombre:"Cuando sea mayor",                artista:"Josefa"},
        32: {nombre:"Danke Danke",                     artista:"Emma"},
        33: {nombre:"Do re mi fa sol",                 artista:"Bernardo"},
        34: {nombre:"El colegio es para aprender",     artista:"Emma"},
        35: {nombre:"Enchanted",                       artista:"Clarita"},
        36: {nombre:"Estrellita",                      artista:"Rafael"},
        37: {nombre:"Gallo Pelado",                    artista:"Borja"},
        38: {nombre:"Gohstbuster",                     artista:"Clemente"},
        39: {nombre:"Jurassic Park",                   artista:"Clemente"},
        40: {nombre:"La jardinera",                    artista:"Lucas"},
        41: {nombre:"La Maldita Roberta",              artista:"Martín"},
        42: {nombre:"Long Live",                       artista:"Clarita"},
        43: {nombre:"Milo el doctor",                  artista:"Pedro"},
        44: {nombre:"Piratas del caribe",              artista:"Raimundo"},
        45: {nombre:"Polka de los perros",             artista:"Clemente"},
        46: {nombre:"Schwarz und weiss",               artista:"Martín"},
        47: {nombre:"Sky full of stars",               artista:"Josefa"},
        48: {nombre:"Solsito porfavor",                artista:"Emma"},
        49: {nombre:"Star Wars",                       artista:"Lucas"},
        50: {nombre:"Thunderstruck",                   artista:"Lucas"},
        51: {nombre:"Yo nunca vi televisión",          artista:"Martín"},
        52: {nombre:"Yo vendo unos ojos negros",       artista:"Eduardo"},
        53: {nombre:"Jurassic Park",                   artista:"Agustín"},
        54: {nombre:"Los monitos",                     artista:"Josefa y Emilio"},
        55: {nombre:"Perdonarte para que",             artista:"Clarita"},
        56: {nombre:"Rodolfo el Reno",                 artista:"Josefa"},
        57: {nombre:"With you",                        artista:"Clarita"},
        58: {nombre:"El mas pequeño",                  artista:"Samuel"},
        59: {nombre:"I Don't Care",                    artista:"Max"},
        60: {nombre:"Bundle of Joy",                   artista:"Florencia"},
        61: {nombre:"Himno a la Alegría",              artista:"Grupo Musical"},
        62: {nombre:"Message in a Bottle",             artista:"The Police"}
    };

    /* --------------------------------------------------------------------------
       ELEMENTOS DEL DOM
    -------------------------------------------------------------------------- */
    const miniaturasContainer = document.getElementById('miniaturasContainer');
    const nombreCancionEl     = document.getElementById('nombreCancion');
    const artistaEl           = document.getElementById('artista');
    const audio               = document.getElementById('audio');
    const audioAlt            = document.getElementById('audioAlt');
    const guitarraBtn         = document.getElementById('guitarraBtn');
    const playPauseBtn        = document.getElementById('playPause');
    const icon                = document.getElementById('icon');
    const cover               = document.getElementById('cover');
    const seekBar             = document.getElementById('seekBar');

    /* Estado de audio actual */
    let currentAudio = audio;
    let isAlt        = false;             // ¿Estamos usando audio alternativo?

    /* --------------------------------------------------------------------------
       FUNCIONES PRINCIPALES
    -------------------------------------------------------------------------- */
    function selectAudio (filename, coverImage, metadata) {
      if (currentAudio && !currentAudio.paused) currentAudio.pause();

      audio.src = `${folders[1]}/${filename}`;
      cover.style.backgroundImage = `url('${folders[2]}/${coverImage}')`;

      nombreCancionEl.textContent = metadata.nombre;
      artistaEl.textContent       = metadata.artista;

      localStorage.setItem('selectedAudio',   `${folders[1]}/${filename}`);
      localStorage.setItem('selectedCover',   `${folders[2]}/${coverImage}`);
      localStorage.setItem('selectedNombre',  metadata.nombre);
      localStorage.setItem('selectedArtista', metadata.artista);

      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title:  metadata.nombre,
          artist: metadata.artista,
          artwork:[{ src: `${folders[2]}/${coverImage}`, sizes:'512x512', type:'image/jpeg' }]
        });
        navigator.mediaSession.setActionHandler('play',  () => { currentAudio.play();  setIcon('pause'); });
        navigator.mediaSession.setActionHandler('pause', () => { currentAudio.pause(); setIcon('play');  });
      }

      const coverIndex = parseInt(filename.match(/(\d+)\.mp3/)[1], 10);
      if (coversConGuitarra.includes(coverIndex)) {
        guitarraBtn.style.display = 'flex';
        guitarraBtn.disabled      = true;
        guitarraBtn.style.filter  = 'grayscale(100%)';
        guitarraBtn.style.opacity = '0.6';
        guitarraBtn.classList.remove('active');

        audioAlt.src = `${folders[1]}/` + filename.replace('.mp3','_sg.mp3');
        audioAlt.preload = 'auto';
        audioAlt.load();
        audioAlt.addEventListener('canplaythrough', () => {
          guitarraBtn.disabled     = false;
          guitarraBtn.style.filter = 'none';
          guitarraBtn.style.opacity= '1';
        }, {once:true});
      } else {
        guitarraBtn.style.display = 'none';
      }

      currentAudio = audio;
      currentAudio.load();
      seekBar.value = 0;
      seekBar.max   = 1;
      setIcon('play');
    }

    function togglePlay () {
      if (!currentAudio.src) return;
      if (currentAudio.paused) {
        const playPromise = currentAudio.play();
        if (playPromise !== undefined) {
          playPromise.catch(error => {
            console.error("Error playing audio:", error);
          });
        }
      } else {
        currentAudio.pause();
        setIcon('play');
      }
    }

    function setIcon (state) {
      if (state === 'play') {
        icon.className = 'icon play-icon';
        icon.innerHTML = '';
      } else {
        icon.className = 'pause-icon';
        icon.innerHTML = '<div></div><div></div>';
      }
    }

    [audio, audioAlt].forEach(aud => {
      aud.addEventListener('timeupdate', e => {
        if (!isNaN(e.target.duration)) {
          seekBar.max   = Math.floor(e.target.duration);
          seekBar.value = Math.floor(e.target.currentTime);
        }
      });
      aud.addEventListener('ended', () => setIcon('play'));
      aud.addEventListener('playing', () => setIcon('pause'));
    });

    seekBar.addEventListener('input', () => {
      currentAudio.currentTime = seekBar.value;
    });

    playPauseBtn.addEventListener('click', togglePlay);

    guitarraBtn.addEventListener('click', () => {
      const savedAudio = localStorage.getItem('selectedAudio');
      const coverIndex = parseInt(savedAudio.match(/(\d+)\.mp3/)[1], 10);
      if (!coversConGuitarra.includes(coverIndex)) return;

      const time    = currentAudio.currentTime;
      const playing = !currentAudio.paused;

      guitarraBtn.classList.toggle('active');
      isAlt = guitarraBtn.classList.contains('active');
      localStorage.setItem('isAlt', isAlt.toString());

      currentAudio.pause();
      currentAudio = isAlt ? audioAlt : audio;
      currentAudio.currentTime = time;
      if (playing) currentAudio.play();
    });

    window.addEventListener('DOMContentLoaded', () => {
      const savedAudio   = localStorage.getItem('selectedAudio')   || `${folders[1]}/1.mp3`;
      const savedCover   = localStorage.getItem('selectedCover')   || `${folders[2]}/cover1.jpeg`;
      const savedNombre  = localStorage.getItem('selectedNombre')  || metadatos[1].nombre;
      const savedArtista = localStorage.getItem('selectedArtista') || metadatos[1].artista;
      const savedIsAlt   = localStorage.getItem('isAlt') === 'true';

      cover.style.backgroundImage = `url('${savedCover}')`;
      nombreCancionEl.textContent = savedNombre;
      artistaEl.textContent       = savedArtista;
      audio.src = savedAudio;

      const coverIndex = parseInt(savedAudio.match(/(\d+)\.mp3/)[1], 10);
      guitarraBtn.style.display = coversConGuitarra.includes(coverIndex) ? 'flex' : 'none';

      if (coversConGuitarra.includes(coverIndex) && savedIsAlt) {
        isAlt        = true;
        guitarraBtn.classList.add('active');
        currentAudio = audioAlt;
      } else {
        isAlt        = false;
        currentAudio = audio;
      }

      if (coversConGuitarra.includes(coverIndex)) {
        audioAlt.src = savedAudio.replace('.mp3', '_sg.mp3'); // Solo si tiene versión sin guitarra
        audioAlt.preload = 'auto';
        audioAlt.load();
      }

      audio.addEventListener('loadedmetadata', () => setIcon('play'));

      /* Generar botones de miniaturas en orden inverso */
      for (let i = totalCovers; i >= 1; i--) {
        const btn = document.createElement('button');
        btn.className = 'miniatura';
        btn.setAttribute('data-label', i);
        btn.style.backgroundImage = `url('${folders[2]}/cover${i}.jpeg')`;
        btn.onclick = () => selectAudio(`${i}.mp3`, `cover${i}.jpeg`, metadatos[i]);
        miniaturasContainer.appendChild(btn);
      }

      // Mostrar el botón de detalles
      const detailsArrow = document.getElementById('detailsArrow');
      detailsArrow.classList.add('show');

      // Manejar clic en el botón de detalles
      detailsArrow.addEventListener('click', () => {
        // Obtener el ID de la canción actual del src del audio
        const currentSongId = currentAudio.src.split('/').pop().replace('.mp3', '').replace('_sg', '');
        const currentTime = currentAudio.currentTime;
        
        // Construir la URL de la carátula basada en el ID de la canción
        const currentCover = `${folders[2]}/cover${currentSongId}.jpeg`;
        
        // Construir la URL con los parámetros necesarios
        const params = new URLSearchParams({
          song: currentSongId,
          cover: currentCover,
          title: nombreCancionEl.textContent,
          audio: `${folders[1]}/${currentSongId}.mp3`,
          time: currentTime
        });
        
        window.location.href = `details.html?${params.toString()}`;
      });
    });
  </script>
</body>
</html>
